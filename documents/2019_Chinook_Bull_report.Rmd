---
title: "2019 Imnaha River Chinook Salmon and Bull Trout summaries"
author: "Joseph Feldhaus (ODFW) & Ryan Kinzer (NPT)"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE, include = FALSE}
library(knitr)
library(pander)
library(tidyverse)
library(lubridate)
library(scales)
library(PITcleanr)
#library(xlsx)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error = TRUE)

panderOptions('round',2)
```

### Noteable Highlights/Data issues  

The purpose of this section is to provide a quick review of important events that occured during the 2019 trapping season.

* Imnaha Weir installation date: **xx June/July, 2019**.
* Within the Imnaha River basin, the Bull trout PIT tags used in the analyis were limited to detections after 1 March 2019.   
* Chinook PIT tag detections were constrained to 5/1/2019 - 10/1/2019.    


```{r load_data, echo=FALSE, message=FALSE, warning=FALSE}
# Un-comment out the source code to update the data
#source("./R/02_load_chinook_bull_data.R")


# df<-readRDS("./data/PITcleanr_2019_chs_bull.rds")%>%
#   filter(Group=="ImnahaRiver")
# detect_hist<-readRDS("./data/2019_detect_hist.rds")
# load("./data/config_data_20190531.rda")


df <- dat_all() %>% # accesses data from shiny load button
 filter(Group == 'ImnahaRiver')

```

```{r}
# summarize detection history data
yr = 2019
# Trap Install Date ----
trap_install <- FALSE # TRUE OR FALSE

#if(trap_install){
  install_date <- ymd_hm(paste0(yr,"/06/01 15:00")) # we could add time and second if we wanted
#}

MaxTimes <- df %>%
  filter(SiteID %in% c('IR4', 'IML','IMNAHW','IR5')) %>%
  select(TagID, lastObsDateTime, SiteID) %>%
  mutate(SiteID = factor(SiteID,levels=c('IR4', 'IML','IMNAHW','IR5'))) %>%
  group_by(TagID, SiteID) %>%
  slice(which.max(lastObsDateTime)) %>%
  spread(SiteID, lastObsDateTime, drop = FALSE) %>% 
  rename(IR4_max=IR4,IML_max=IML, IMNAHW_max=IMNAHW, IR5_max=IR5) 


# need to use drop = FALSE in spread with all factor levels
detect_hist_simple <- df %>%
  filter(!SiteID %in% c('COC', 'BSC')) %>%
  select(TagID, firstObsDateTime, SiteID) %>% # removed Mark.Species, Origin, ReleaseDate
  mutate(SiteID = factor(SiteID,levels=c("IR1","IR2","IR3","IR4","IML","IMNAHW","IR5"))) %>%
  group_by(TagID, SiteID) %>%
  slice(which.min(firstObsDateTime)) %>%
  spread(SiteID, firstObsDateTime, drop = FALSE) %>%
  left_join(select(df, TagID, Mark.Species, Origin, Release.Date), by = 'TagID') %>%
  left_join(df %>%
              mutate(UserProcStatus = AutoProcStatus) %>%
              rename(ObsDate = firstObsDateTime, lastObsDate = lastObsDateTime) %>%
              estimateSpawnLoc(), by = 'TagID') %>%
  left_join(MaxTimes,by='TagID') %>%
  select(Mark.Species, Origin, Release.Date, everything())%>%
  arrange(Mark.Species,Origin,TagID)

###I separated the mutate statements to calculate travel days because they don't work well with missing dates##
###We need detections at an interrogation site before the calculations work###

detect_hist <- detect_hist_simple%>%
  mutate(min_IR1orIR2 = if_else(is.na(IR1), IR2, IR1),
         IR1_IR3 = difftime(IR3, min_IR1orIR2, units = 'days'),
         IR3_IR4 = difftime(IR4, IR3, units = 'days'),
         IR4_IML = difftime(IML, IR4, units = 'days'),
         IML_IMNAHW = difftime(IMNAHW, IML, units = 'days'),
         IR4_IMNAHW = difftime(IMNAHW, IR4, units = 'days'),
         IR4_IR5 = difftime(IR5, IR4, units = 'days')) %>%
  mutate(NewTag = case_when(
                    Mark.Species == "Bull Trout" & trap_install & Release.Date > install_date ~ "TRUE",
                    TRUE ~ "FALSE"),
         WeirArrivalDate = if_else(!is.na(IR4), IR4, #if IR4 has a date, use IR4,
                                   if_else(!is.na(IML), IML, # use IML,
                                           if_else(!is.na(IMNAHW), IMNAHW, IR5))), # if IMNAHW has a date use IMNAHW otherwise use IR5
         Arrival_Month = month(WeirArrivalDate, label = TRUE, abbr = FALSE),
         TagStatus = ifelse(grepl("(IR4|IML|IMNAHW|IR5)",TagPath) & WeirArrivalDate <= install_date, "Passed: <11 June",
                            ifelse(grepl("IR5", TagPath) & NewTag == "True", "NewTag",
                                   ifelse(grepl("IR5", TagPath) & NewTag == "False", "Passed",
                                          ifelse(grepl("IMNAHW", TagPath), "Trapped",
                                                 ifelse(grepl("IML", TagPath), "Attempted Ladder",
                                                        ifelse(grepl("IR4", TagPath), "At Weir", paste0("Last obs: ", AssignSpawnSite))))))),
         TrapStatus = ifelse(is.na(WeirArrivalDate), "No obs at weir sites",
                             ifelse(WeirArrivalDate <= install_date, "Panels Open", "Panels Closed")),
         PassageRoute = ifelse(!grepl("Passed", TagStatus), NA,
                               ifelse(grepl("IMNAHW", TagPath), "Handled",
                                      ifelse(grepl("IML", TagPath), "IML obs = T", "IML obs = F"))))

detect_hist$TagStatus[detect_hist$IR4_max>detect_hist$IMNAHW&detect_hist$IMNAHW>install_date]<-"Trapped: Obs Below Weir"#tags without a detection at IR5 that fall below the weir
detect_hist$TagStatus[detect_hist$TagStatus=="Trapped: Obs Below Weir"&detect_hist$IR5>detect_hist$IR4_max]<-"Passed"#fell below weir, but made it back to IR5

detect_hist$PassageRoute[detect_hist$IMNAHW>install_date]<-"Handled"#tag paths that end at the trap
#detect_hist$PassageRoute[detect_hist$TagID=="3D9.1C2D90A52D"]<-"Handled 6/5/18"#tag paths that end at the trap

```

### Unique PIT-tag observations within the Imnaha Basin by species
```{r }
df %>%
  group_by(Mark.Species, Origin) %>%
  summarise(Unique_Tags = n_distinct(TagID)) %>%
  pander()
```

### Unique PIT-tag observations by species, origin and release site
```{r }
df %>%
  mutate(Release.Year = year(Release.Date)) %>%
  group_by(Mark.Species, Origin, Release.Site.Code) %>%
  summarise(Unique_Tags = n_distinct(TagID)) %>%
  pander()
```



### Unique PIT-tag observations by species, SiteID and origin
Unexpanded PIT tag counts at Big Sheep Creek (BSC), Cow Creek (COC), the mainstem PIT tag interrogation sites (IR1-IR5), the Imnaha adult ladder (IML), and the Imnaha facility trap house (IMNAHW).   
```{r }
df %>%
  mutate(Release.Year = year(Release.Date)) %>%
  group_by(Mark.Species,SiteID,Origin) %>%
  summarise(Unique_Tags = n_distinct(TagID)) %>%
  pander()
```


### Unique PIT-tag observations within the Imnaha Basin by species, origin and arrival date
First detection dates of unexpanded Bull Trout and Chinook salmon PIT tags at tributary (COC, BSC) and mainstem (IR1-IR5, IML, IMNAHW) PIT tag interrogation sites.  Site are organized from downstream to upstream with the most downstream interrogation site (COC) in the top two panels.   
```{r Unique Tag counts, fig.width=8,fig.height=10,message=FALSE, warning=FALSE}

df %>%
  #filter(!SiteID%in%c("BSC","COC")) %>%
  group_by(TagID, Mark.Species, Origin, Release.Site.Code, SiteID) %>%
   slice(which.min(lastObsDateTime)) %>%
  ggplot(aes(x=lastObsDateTime, fill=Origin)) +
  geom_histogram(colour = 'black', alpha = .5, bins = 100) +
  facet_grid(SiteID~Mark.Species,scales="free") +
  scale_fill_brewer(palette = 'Set1') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  theme(panel.grid.major=element_blank())+
  labs(x = "First detection date",
       y = "Count")
```

### PIT tag detection efficiency at the node level  

Detection efficiencies at the node level (i.e., upstream and downstream antenna grous) and conversion rates for Bull Trout and Chinook Salmon detected at IR1-IR5, IML, and IMNAHW.  Detections in the trap house from the measuring board PIT reader will be labeled "IMNAHWB0".

```{r efficiency}
tmp_df <- df %>% 
  anti_join(detect_hist %>%
            filter(NewTag == 'True') %>%
            select(TagID)
            ) %>%
  #mutate(Node = gsub("A0", "B0", Node)) %>%# calculates efficiency at the site level
  identity()

nodes <- c('IR1', 'IR2', 'IR3B0', 'IR3A0', 'IR4B0', 'IR4A0',
           'IMLB0', 'IMLA0', 'IMNAHWB0','IMNAHWA0','IR5B0', 'IR5A0')

tmp_df %>%
  #mutate(Obs_location = ifelse(grepl("IR", Node), "Instream", "Ladder")) %>%
  group_by(Mark.Species) %>%
  do(estNodeEff(.,node_order = node_order, node = nodes)) %>%
  select(Mark.Species, Node, tagsAtNode, estTagsAtNode, detEff) %>% pander()
  # mutate(det_eff = Recaps/Marks, #ifelse(!grepl('IMNAHW', Node), Recaps/Marks, 1.00),
  #        se_eff = (1/Marks^2)*(Marks*det_eff)*(1-det_eff),
  #        N_tags = Unique_tags/det_eff,
  #        se_N = sqrt(((Marks+1)*(Unique_tags+1)*(Marks - Recaps) * (Unique_tags - Recaps))/ ((Recaps+1)^2 * (Recaps+2))),
  #        lwr_N = N_tags - 1.96*se_N,
  #        upr_N = N_tags + 1.96*se_N,
  #        N_up = lag(N_tags),
  #        Conversion = paste0(round(N_tags/N_up*100),"%")
  #        #Node = gsub("B0", "", Node)
  #        ) %>%
  # ungroup() %>%
  # select(Mark.Species, Node, Unique_Tags = Unique_tags, Marks, Recaps, det_eff, Conversion) %>%
  #pander()

```

###PIT tag detection efficiency at the site level  

Detection efficiencies and converson rates at the site level.  See the Node level estimates above for an efficiency estimate at IR5B0.
```{r echo=FALSE}

tmp_df <- df %>% 
  anti_join(detect_hist %>%
            filter(NewTag == 'True') %>%
            select(TagID)
            ) %>%
  mutate(Node = gsub("A0", "B0", Node)) %>%# calculates efficiency at the site level
  identity()

nodes <- c('IR1', 'IR2', 'IR3B0', 'IR4B0',
           'IMLB0', 'IMNAHWB0', 'IR5B0')

tmp_df %>%
  group_by(Mark.Species) %>%
  do(estNodeEff(.,node_order = node_order, node = nodes)) %>%
  mutate(SiteID = gsub("B0", "", Node)) %>%
  select(Mark.Species, SiteID, tagsAtSite = tagsAtNode, estTagsAtSite = estTagsAtNode, detEff) %>%
  filter(SiteID != 'IR5') %>% pander()
  # mutate(det_eff = Recaps/Marks, #ifelse(!grepl('IMNAHW', Node), Recaps/Marks, 1.00),
  #        se_eff = (1/Marks^2)*(Marks*det_eff)*(1-det_eff),
  #        N_tags = Unique_tags/det_eff,
  #        se_N = sqrt(((Marks+1)*(Unique_tags+1)*(Marks - Recaps) * (Unique_tags - Recaps))/ ((Recaps+1)^2 * (Recaps+2))),
  #        lwr_N = N_tags - 1.96*se_N,
  #        upr_N = N_tags + 1.96*se_N,
  #        N_up = lag(N_tags),
  #        Conversion = paste0(round(N_tags/N_up*100),"%"),
  #        Node = gsub("B0", "", Node)
  #        ) %>%
  # ungroup() %>%
  # select(Mark.Species, Node, Unique_Tags = Unique_tags, Marks, Recaps, det_eff, Conversion) %>% filter(Node!="IR5")%>%
  # pander()

```


### Unique PIT-tag observations at the Imnaha Weir by trap status (based on observation date at weir sites (IR4, IML, IMNAHW, IR5)
```{r }
detect_hist %>%
  select(Mark.Species, TrapStatus, IR4, IML, IMNAHW, IR5) %>%
  gather(SiteID, firstObsDateTime, IR4:IR5, na.rm = TRUE) %>%
  group_by(Mark.Species, TrapStatus, SiteID) %>%
  summarise(Unique_tags = n()) %>%
pander()  
```

### Passage routes of PIT-tagged fish successfully reaching and being detected at IR5 
This summary is limited to previously tagged fish (i.e., not tagged at IMNAHW in 2019) detected at IR5.  

*Passage Route descriptions:*  
* *Handled*: Processed in the trap house (IMNAHW) followed by a detection at IR5.  
* *IML obs = F *: Not detected at IML (F = False).  
* *IML obs = T*:  Detected at IML (T = True). 

*Trap Status descriptions*  
* *No obs at IR4*: no PIT tag observation at IR4.  
* *Panels Closed*: Indicates that the weir was fully operational.  
* *Panels Open*:  Separates out detections at IR5 before the weir was operational.  

 
```{r message=FALSE, warning=FALSE}
detect_hist %>%
  filter(grepl('Passed', TagStatus), NewTag == 'False') %>%
  #filter(grepl('Passed', TagStatus)) %>%
  #group_by(Mark.Species, TrapStatus, PassageRoute) %>% 
  group_by(Mark.Species, PassageRoute, TrapStatus) %>%
  arrange(Mark.Species,PassageRoute)%>%
  summarise(Unique_tags = n()) %>%
pander()
```


### Unique PIT-tag observations by tag status  
*Tag status descriptions:*  
* *At Weir*: Observed at IR4 but not IML, IMNAHW, or IR5.   
* *Attempted Ladder*: Detected at IML, but not detected at IMNAHW.   
* *Last obs: BSC*: Observed at Big Sheep Creek.  
* *Last obs: IR1/IR2/IR3*: Observed at IR1, IR2, or IR3, respectively.  
* *NewTag*: Bull Trout tagged at IMNAHW in 2018.  
* *Passed*: Detected at IR5.  
* *Trapped*: Handled at IMNAHW, but no subsequent detection IR5.  
* *Trapped: Obs Below Weir*: Handled at IMNAHW & detected at IR4>IMNAHW  
 


```{r}
detect_hist %>%
  group_by(Mark.Species, Origin, TagStatus) %>%
  summarise(Unique_Tags = n()) %>%
  pander()

##filter for detections at IR4, IR5, IML, IMNAHW
AtWeir<-detect_hist%>%filter(str_detect(TagPath,"IR4|IR5|IML|IMNAHW"))%>%
  mutate(LastObsDate=as.Date(LastObs,format="%m/%d/%Y"))

ggplot(subset(AtWeir,LastObsDate>"2019/05/31"),aes(x=as.Date(LastObs,"%m/%d/%Y",tz="UTC"),fill=TagStatus))+
  geom_histogram(colour = 'black', alpha = .5, binwidth=1)+
  geom_vline(xintercept = as.numeric(as.Date("2018-06-11")), linetype=2)+
  facet_wrap(~Mark.Species,scales="free_y",ncol=1)+
  scale_x_date(date_breaks="5 days",date_label="%m-%d")+
  scale_fill_brewer(palette = 'Set1') +
  theme_bw() +
  theme(legend.position = 'bottom')+ 
  guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  theme(panel.grid.major=element_blank())+
  ggtitle("Tag status: last detection at IR4/IR5/IML/IMNAHW after 5/31/18")+
  labs(x = "Last Observation Date",
       y = "Count")
```


## Travel time between sites

```{r Travel Time, fig.width=8,fig.height=10}
detect_hist %>%
  select(TagID, Mark.Species, Origin, Arrival_Month, IR1_IR3:IR4_IR5) %>%
  mutate_at(c(4:6), as.numeric) %>%
  gather(Reach, Travel_Time, IR1_IR3:IR4_IR5) %>%
  mutate(Reach = fct_relevel(Reach, c("IR1_IR3", "IR3_IR4", "IR4_IML", "IML_IMNAHW", "IR4_IMNAHW", "IR4_IR5"))) %>%
  filter(Travel_Time >= 0) %>%
  #filter(Reach == "IR4_IR5") %>%
  ggplot(aes(x = Travel_Time, fill = Origin)) +
  geom_histogram(colour = 'black', alpha = .5, binwidth = 1) +
  scale_fill_brewer(palette = 'Set1') +
  facet_grid(Reach ~ Mark.Species, scales = "free") +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = 'Travel Time (Days)',
       y = 'Count') 
```



```{r days_site, fig.width=8,fig.height=10, eval = FALSE}
### Number of days spent at a site
# number of days at a site
df %>%
  filter(!SiteID %in% c('COC','BSC')) %>%
  group_by(Mark.Species, Origin, SiteID, TagID) %>%
  summarise(minObsDate = min(lastObsDateTime),
          maxObsDate = max(lastObsDateTime),
          hours = difftime(maxObsDate, minObsDate, units = 'days')) %>%
  ggplot(aes(x = hours, fill = Origin)) +
  geom_histogram(colour = 'black', alpha = .5, bins = 20) +
  scale_fill_brewer(palette = 'Set1') +
  facet_grid(SiteID ~ Mark.Species) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = 'Days (max(obsDate) - min(obsDate))',
       y = 'Count') 
```

### Tag Status = "Last Obs:  IR3" 

Summary of tags last observed at IR3. 

```{r Tag Status At IR3, echo=FALSE, message=FALSE, warning=FALSE}
IR3tags<-detect_hist%>%filter(TagStatus=="Last obs: IR3")%>%select(TagID,Mark.Species,Origin,TagStatus,IR3)%>%
  arrange(Mark.Species,IR3)

IR3tags%>%group_by(Mark.Species,Origin)%>%tally() %>% pander()

#IR3tags %>% rename(IR3_min=IR3)%>%mutate(IR3_min=as.Date(IR3_min,format="%m/%d"))%>% select(-TagStatus)%>%pander()


```


```{r, eval = FALSE}
###Minimum Travel Time from IR4 to IMNAHW  

detect_hist %>%
  select(TagID, Mark.Species, Origin, IR4_IML,IR4_IMNAHW,IML_IMNAHW) %>%
  mutate_at(c(4:6), as.numeric) %>%
  gather(Reach, Travel_Time, IR4_IML,IR4_IMNAHW,IML_IMNAHW) %>%
  filter(Travel_Time >= 0) %>%
  mutate(Reach=factor(Reach,levels=c('IR4_IML','IR4_IMNAHW','IML_IMNAHW')))%>%
  #filter(Reach == "IR4_IR5") %>%
  ggplot(aes(x = Travel_Time, fill = Origin)) +
  geom_histogram(colour = 'black', alpha = .5, bins = 20) +
  scale_fill_brewer(palette = 'Set1') +
  facet_grid(Reach ~ Mark.Species, scales = "free") +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = 'Travel Time (Days)',
       y = 'Count') 
  
```



### Tag Status = "At Weir" 

Fish assigned a tag status of "At Weir" have been detected at IR4 but have not been detected at IML, handled in the trap (IMNAHW), or detected at IR5. IR4_min and IR4_max are the first and last detection dates at IR4, respectively.

```{r Tag Status At Weir, echo=FALSE, message=FALSE, warning=FALSE}
TagStatusAtWeir<-detect_hist%>%filter(TagStatus=="At Weir")%>%select(TagID,Mark.Species,Origin,TagStatus,IR4,IR4_max)%>%
  arrange(Mark.Species,IR4_max)

TagStatusAtWeir%>%group_by(Mark.Species,Origin)%>%tally() %>% pander()

TagStatusAtWeir %>% rename(IR4_min=IR4)%>%mutate(IR4_min=as.Date(IR4_min,format="%m/%d"), IR4_max=as.Date(IR4_max,format="%m/%d"))%>% select(-TagStatus)%>%pander()

```

### Source Data
The complete PIT-tag histories for Chinook Salmon and Bull trout detected during 2019 in the Imnaha River Basin were downloaded as two seperate files located on the [PTAGIS ftp server](ftp://ftp.ptagis.org/MicroStrategyExport/). The files are the result of running "Complete Tag History" queries that were parameterized on the [PTAGIS website](https://www.ptagis.org/) and set-up to run and save automatically at 6:00 a.m. and 12:00 p.m. each day.  The first file contains Chinook Salmon PIT-tag detections and is stored at the "*feldhauj/2019_Imnaha_CompleteTagHistory.csv*" file path within the ftp server.  The second file contains Bull trout detections and is stored within the "*rkinzer/Imnaha_Bull_Complete_Tag_History.csv*" filepath.  We are then using an R-script to download the files from the PTAGIS ftp server and combine them into a single file.  Once the file is combined all Chinook Salmon and Bull trout tag detections are processed using the R package [PITcleanR](https://github.com/kevinsee/PITcleanR). The final dataset provides a simplified tag history with the first and last detection dates at each PIT-tag detection node (i.e., a single spanning array or antenna) and information regarding upstream and downstream movements and a more general migration direction.   

#####*Creating the PTAGIS Chinook Complete Tag History report:*  
* *Tag list #1:* All adult Chinook salmon detected at Lower Granite Dam.    
* *Event Date:* Between 5/1/2019 and 10/1/2019
* *Event Sites:* IR1, IR2, IR3, IR4, IR5, IML, IMNAHW, BSC, IMNAHR
* *Mark Species:* Chinook
* *Event Type:* Observation, Recapture, Recovery

#####*Creating the PTAGIS Bull Trout Complete Tag History report:*  
* *Query:* All PIT-tagged Bull trout detected in the Imnaha River Basin in 2018.   
* *Event Date:* Between 1/1/2018 and 10/1/2018
* *Event Sites:* IR1, IR2, IR3, IR4, IR5, IML, IMNAHW, COC, BSC, IMNAHR
* *Mark Species:* Bull Trout
* *Event Type:* Observation, Recapture, Recovery 


#####*Output Files:*  
* *PITcleanr_2019_chs_bull.xlsx*:  The complete tag histories from 2018_Imnaha_ComploeteTagHistory.csv and Imnanha_Bull_Complete_Tag_Histories.csv combined into a single file and processed with the PITcleanr R-package.  
* *detect_hist.xlsx*: A pivot table style summary. (This description is not complete JF 7/6/18) Each row = a unique PIT tag code.  Columns correspond to first detection dates at IR1-IR5, IML, and IMNAHW.  This file contains the Trap Status, TagPath, Passage Route, and TagStatus fields.  Trap status references the dates the weir was operating. TagPath is a character string representing detections at PIT tag observations sites.  TagStatus represents the last known location of the tag and whether the tag has arrived at the weir, has attempted the ladder (i.e., detected at IML), passed the weir (i.e., detected at IR5), or has been trapped (i.e., detected at IMNAHW). The tag pathway describes the passage route through the weir.
